name: Check for base image updates

on:
  workflow_call:
    inputs:
      repo_owner:
        required: true
        type: string
      baseimage:
        required: true
        type: string
      email:
        required: true
        type: string
      app_name:
        required: true
        type: string        
    secrets:
      repo_scoped_token:
        required: true

jobs:
  get-baseimage-version:
    runs-on: ubuntu-latest
    outputs:
      modified: ${{ steps.git-check.outputs.modified }}
    steps:
      - uses: actions/checkout@v2.4.0
        with:
          token: ${{ secrets.repo_scoped_token }}
      - name: Fetch release version
        run: |
          curl -sL https://api.github.com/repos/linuxserver/docker-baseimage-${{ inputs.baseimage }}/releases/latest | \
          jq -r ".tag_name" > release-versions/lsiobase-${{ inputs.baseimage }}-latest.txt
      - name: Check for modified files
        id: git-check
        run: echo ::set-output name=modified::$([ -z "`git status --porcelain`" ] && echo "false" || echo "true")
      - name: Commit latest release version
        if: steps.git-check.outputs.modified == 'true'
        run: |
          git config --global user.name '${{ inputs.repo_owner }}'
          git config --global user.email '${{ inputs.email }}'
          git commit -am "New lsiobase-${{ inputs.baseimage }} release version"
          git push

  release:
    runs-on: ubuntu-latest
    needs: get-baseimage-version
    if:  ${{ needs.get-baseimage-version.outputs.modified == 'true' }}
    steps:  
      - 
        name: Checkout
        uses: actions/checkout@v2.4.0
      -
        name: Generate release version
        id: gen_release
        run: |
          IMAGE_VERSION=$(curl -s "https://api.github.com/repos/${{ inputs.repo_owner }}/docker-${{ inputs.app_name }}/releases/latest" | jq -r .tag_name)
          APP_VERSION=$(echo $IMAGE_VERSION | awk -NF '-' '{print $1}')
          SPAD_VERSION=$(( $(echo $IMAGE_VERSION | awk -NF '-' '{print $NF}' | cut -c 5-8 | sed 's/^0*//')+1 ))
          RELEASE_TAG=$APP_VERSION-spad$(printf "%03d" $SPAD_VERSION)
          echo "**** Setting release tag to $RELEASE_TAG ****"
          echo ::set-output name=tag_name::${RELEASE_TAG} 
      - 
        name: Do release
        uses: softprops/action-gh-release@v1
        with:
          body: "* Updated ${{ inputs.app_name }} with new ${{ inputs.baseimage }} baseimage"
          token: ${{ secrets.repo_scoped_token }}
          tag_name: ${{ steps.gen_tags.outputs.tag_name }}
